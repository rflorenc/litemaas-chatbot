# syntax=docker/dockerfile:1
# Open Source Mentor Bot - OpenShift-Compatible Containerfile
# Uses Red Hat Universal Base Image (UBI9) with Python 3.9

FROM registry.access.redhat.com/ubi9/python-39:latest

# Set labels
LABEL name="open-source-mentor-bot" \
      version="1.0.0" \
      description="Open Source Mentor Bot - Red Hat Hackathon Demo (OpenShift)" \
      maintainer="rlteam" \
      io.k8s.description="Open Source Mentor Bot for Red Hat Hackathon" \
      io.openshift.tags="python,flask,chatbot,llm,ubi9"

# Set working directory
WORKDIR /app

# Install curl for health checks
#RUN dnf install -y curl && \
#    dnf clean all

# Copy requirements first for better layer caching
COPY requirements.txt /app/

# Install Python dependencies
RUN pip install --no-cache-dir --upgrade pip && \
    pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY app/ /app/app/
COPY run.py /app/

# OpenShift arbitrary UID support
# UBI images are already OpenShift-compatible, but ensure permissions
# Grant permissions to root group (GID 0) so any UID can run
#RUN chgrp -R 0 /app && \
#    chmod -R g=u /app && \
#    chmod g+w /app

# Set environment variables
ENV PORT=8080 \
    PYTHONUNBUFFERED=1 \
    FLASK_APP=run.py

# Expose port
EXPOSE 8080

# No specific USER directive - OpenShift will assign arbitrary UID
# Container runs as non-root with UID from project range and GID 0

# Health check (may not work in OpenShift - use k8s probes instead)
#HEALTHCHECK --interval=30s --timeout=3s --retries=3 \
#    CMD curl -fsS http://localhost:${PORT}/health || exit 1

# Use gunicorn for production
CMD ["gunicorn", "--bind", "0.0.0.0:8080", "--workers", "2", "--threads", "4", "--timeout", "60", "--access-logfile", "-", "--error-logfile", "-", "run:app"]
